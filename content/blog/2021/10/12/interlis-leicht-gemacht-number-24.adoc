= INTERLIS leicht gemacht #24 - Ilivalidator in/mit QGIS
Stefan Ziegler
2021-10-12
:jbake-type: post
:jbake-status: published
:jbake-tags: INTERLIS,Java,ilivalidator,Graal,GraalVM,QGIS
:idprefix:

Wer kennt es nicht? Daten in QGIS nachgeführt und https://github.com/claeis/ilivalidator[_ilivalidator_] meldet Fehler:

[source,xml,linenums]
----
Error: SO_AWJF_Foerderprogramm_Biodiversitaet_Publikation_20200519.Biotopflaechen.Biotopflaeche.Geometrie: Intersection coord1 (2610894.968, 1249766.404), tids 4b76926f-cef2-4b9e-8750-f3aef21385eb, 4b76926f-cef2-4b9e-8750-f3aef21385eb
Error: line 22: SO_AWJF_Foerderprogramm_Biodiversitaet_Publikation_20200519.Biotopflaechen.Biotopflaeche: tid dc58062e-4251-433b-b124-835356dc873e: duplicate coord at (2621389.108, 1244991.863, NaN)
Error: SO_AWJF_Foerderprogramm_Biodiversitaet_Publikation_20200519.Biotopflaechen.Biotopflaeche.Geometrie: Overlay coord1 (2617574.166, 1240369.683), coord2 (2617621.209, 1240261.671), tids 8ed21983-6692-4f99-b306-f084a364440f, 8ed21983-6692-4f99-b306-f084a364440f
Error: line 36: SO_AWJF_Foerderprogramm_Biodiversitaet_Publikation_20200519.Biotopflaechen.Biotopflaeche: tid 01857f02-9fca-4e18-83af-f97de8744ecd: duplicate coord at (2635087.966, 1247870.588, NaN)
----

Entweder wieder mal einen doppelten Vertexpunkt (`duplicate coords`) oder eine minimalste Überlappung (`Intersection`, `Overlay`) entdeckt. Es gibt in https://qgis.org[_QGIS_] verschiedene Mittel, damit diese Fehler schon gar nicht gemacht werden können und auch Werkzeuge, die solche Fehler aufdecken. Warum aber nicht den Prüfalgorithmus von _ilivalidator_ näher zu _QGIS_ bringen? Damit sichergestellt ist, dass die Geometrien nach einem Export auch tatsächlich valide INTERLIS-Geometrien sind.

Aber wie soll das gehen? _Ilivalidator_ ist in Java geschrieben und QGIS will entweder C++ oder Python. Des Rätsels Lösung habe ich http://blog.sogeo.services/blog/2021/02/02/interlis-leicht-gemacht-number-22.html[hier] im zweiten Teil beschrieben. Ich will für diese zusätzliche Geometrieprüfung in _QGIS_ keine Java-Runtime installiert haben, sondern im Ideafall maximal nur ein Python-Plugin herunterladen und gut ist. Mit https://www.graalvm.org/[_GraalVM_] können einzelne https://www.graalvm.org/reference-manual/native-image/ImplementingNativeMethodsInJavaWithSVM/[Java-Methoden zu shared libraries] (*.so, *.dylib, *.dll) kompiliert werden. Diese wiederum können relativ einfach in Python verwendet werden.


Viel Copy/paste weil Geoemtrieprüfung nicht Teil einer öffentliche API von ilivalidator ist und einige benötigte Parameter so nicht vorhanden sind. (z.B. Werte für erlaubte Overlaps (steckt im Modell))


- Geometrische Auflösung als Parameter resp. für uns in der Regel Millimeter.




Etwas nervte mich seit langem an http://www.umleditor.org/[_INTERLIS-UML-Editor_] auf macOS: Eine Java-Anwendung kann man nicht einfach ins Dock ziehen und gut ist. 

Früher gab es für JavaFX das Tool _javapackager_, das JavaFX-Anwendungen und alle anderen Java-Anwendungen betriebssystemabhängig zu einem Paket inkl. Java-Runtime schnürt. Dieses konnte dann wie jede andere Anwendung auf Linux, Windows oder macOS installiert werden. Praktisch war auch, dass man sich nicht um eine Java-Installation zu kümmern brauchte, weil die Runtime eben mitgeliefert wurde. Leider flog das Tool mit JavaFX aus dem JDK.

Ein paar Jahre (Java 16) später taucht es unter dem Namen https://openjdk.java.net/jeps/392[_jpackage_] in einer sehr ähnlichen Form wieder auf. Einige Features sind nicht mehr vorhanden, so z.B. JavaFX-spezifische Features. Das Wichtigste ist aber immer noch möglich: betriebssystemabhängige Installationspakete für Java-Anwendungen inkl. Runtime erstellen.

Im einfachsten Fall sieht ein Befehl so aus:

[source,xml,linenums]
----
jpackage --icon icon-umleditor-128x128.icns --name umleditor --type dmg --input libs --main-jar umleditor-3.7.6.jar --app-version 3.7.6 -d output 
----

- --icon: Das Icon für die Anwendung. Dateiformat ist leider je nach Betriebssystem unterschiedlich.
- --name: Name der Anwendung
- --type: `dmg` und `pkg` für macOS, `deb` und `rpm` für Linux, `exe` und `msi` für Windows. &laquo;Cross-Herstellung&raquo; - also rpm-Pakete auf Windows herstellen, geht nicht.
- --input: Das Verzeichnis mit den Jar-Dateien.
- --main-jar: Die Jar-Datei mit der Main-Klasse
- --app-version: Versionsnummer
- -d: Das Verzeichnis, wo das Paket gespeichert wird.

Der Befehl liefert mir im Verzeichnis `output` die Datei `ilivalidator-1.11.10.dmg`. Diese .dmg-Datei kann ich jetzt wie gewohnt ausführen und die Anwendung installieren:

image::../../../../../images/interlis_leicht_gemacht_p23/interlis-uml-editor.png[alt="INTERLIS-UML-Editor dmg", align="center"]

Mit ein wenig Zusatzeffort kann man das Ganze hinsichtlich der Grösse optimieren. Standardmässig wird einfach die gesamte Java-Runtime reinkopiert. Bei mir ergibt das eine 56MB grosse DMG-Datei. Man kann mit _jlink_ selber eine Java-Runtime herstellen. Damit diese kleiner wird, muss man die von der Anwendung (also vom INTERLIS-UML-Editor) benötigten Module als Parameter angeben. Dieses Information liefert mir _jdeps_. Und hier wird es ein wenig hakelig, vor allem bei nicht-modularen Java-Anwendungen:

[source,xml,linenums]
----
jdeps --class-path 'libs/*' --multi-release base -recursive --ignore-missing-deps --print-module-deps umleditor-3.7.6.jar
----

liefert mir: `java.base,java.desktop,java.management,java.sql`. Mit dieser Information erzeuge ich mit _jlink_ meine spezifische Java-Runtime:

[source,xml,linenums]
----
 jlink --add-modules java.base,java.desktop,java.management,java.sql --output umleditor-jre
----

Der jpackage-Befehl wird um den Parameter `--runtime-image umleditor-jre` erweitert. Das Paket ist nun nur noch 40MB gross.

Weil dank https://www.geowerkstatt.ch/[Geowerkstatt] https://github.com/claeis/ilivalidator/pull/315[momentan] https://github.com/claeis/ilivalidator/pull/313[richtig] https://github.com/claeis/ilivalidator/pull/312[Schwung] in der GUI-Programmierung von _ilivalidator_ ist, habe ich für die Anwendungen _ilivalidator_, _ili2gpkg_, _ili2c_ und _INTERLIS-UML-Editor_ solche Pakete für Ubuntu, Windows und macOS erstellt: https://ilitools.sogeo.services[ilitools.sogeo.services].

Die Pakete werden mit einer https://github.com/edigonzales/ilitools-packager[Github Action] erstellt. Dabei musste ich feststellen, dass die DMG-Dateien bei mir nicht funktionieren. Aus diesem Grund bin ich auf PKG umgeschwenkt. MacOS bemängelt natürlich immer noch, dass die Pakete nicht signiert sind. Dies wäre technich aber möglich. Die anderen beiden Varianten konnte ich mangels fehlendem Betriebssystem nicht testen.

Den beiden Anwendungen _ilivalidator_ und _ili2gpkg_ habe ich mit `--java-option -Xmx2G` zwei Gigabyte Heap zugewiesen. Es gäbe noch einige weitere spannende Optionen, die man ausprobieren könnte. So sind verschiedene Launcher möglich, was aber bei mir nicht wirklich funktioniert hat. Eventuell können diese Launcher dazu verwendet werden, die Anwendung mit einem GUI zu starten oder in der Konsole. Eine gute Übersicht mit Erläuterung der Möglichkeiten gibt es https://docs.oracle.com/en/java/javase/14/jpackage/image-and-runtime-modifications.html[hier].
